// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model OkTest {
  id String @id @default(cuid())
}

// --- Enums ---
enum Role {
  ADMIN
  MEMBER
  VIEWER
}

enum Confidence {
  LOW
  MEDIUM
  HIGH
}

enum ExperimentStatus {
  PLANNED
  RUNNING
  SUCCEEDED
  FAILED
}

enum ReportType {
  DISCOVERY_PULSE
  OUTCOME_BRIEF
  HYPOTHESIS_BATCH
  PRODUCT_PULSE
}

enum RunStatus {
  QUEUED
  RUNNING
  FAILED
  SUCCEEDED
}

// --- Core org models ---
model User {
  id          String       @id @default(cuid())
  email       String       @unique
  name        String?
  imageUrl    String?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  memberships Membership[]
}

model Organization {
  id          String       @id @default(cuid())
  name        String
  domain      String?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  projects    Project[]
  memberships Membership[]
}

model Membership {
  userId String
  orgId  String
  role   Role         @default(MEMBER)
  user   User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  org    Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@id([userId, orgId])
}

// --- Discovery models ---
model Project {
  id            String        @id @default(cuid())
  orgId         String
  name          String
  description   String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  org           Organization  @relation(fields: [orgId], references: [id], onDelete: Cascade)
  outcomes      Outcome[]
  opportunities Opportunity[]
  experiments   Experiment[]
  insights      Insight[]
  metrics       Metric[]
  reports       Report[]
  ReportRun     ReportRun[]
}

model Outcome {
  id            String        @id @default(cuid())
  projectId     String
  title         String
  description   String?
  targetValue   Float?
  metricId      String?
  status        String        @default("ACTIVE")
  project       Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)
  metric        Metric?       @relation(fields: [metricId], references: [id])
  opportunities Opportunity[]
}

model Opportunity {
  id          String       @id @default(cuid())
  projectId   String
  outcomeId   String?
  title       String
  problem     String?
  evidence    String?
  confidence  Confidence   @default(MEDIUM)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  project     Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  outcome     Outcome?     @relation(fields: [outcomeId], references: [id])
  experiments Experiment[]
}

model Experiment {
  id            String           @id @default(cuid())
  opportunityId String
  hypothesis    String
  method        String?
  status        ExperimentStatus @default(PLANNED)
  result        String?
  opportunity   Opportunity      @relation(fields: [opportunityId], references: [id], onDelete: Cascade)
  Project       Project?         @relation(fields: [projectId], references: [id])
  projectId     String?
}

// --- Evidence & Metrics ---
model Insight {
  id          String     @id @default(cuid())
  projectId   String
  title       String
  summary     String
  source      String?
  impactScore Int        @default(0)
  confidence  Confidence @default(MEDIUM)
  createdAt   DateTime   @default(now())
  project     Project    @relation(fields: [projectId], references: [id], onDelete: Cascade)
}

model Metric {
  id          String           @id @default(cuid())
  projectId   String
  name        String
  unit        String?
  description String?
  snapshots   MetricSnapshot[]
  project     Project          @relation(fields: [projectId], references: [id], onDelete: Cascade)
  Outcome     Outcome[]
}

model MetricSnapshot {
  id       String   @id @default(cuid())
  metricId String
  ts       DateTime
  value    Float
  note     String?
  metric   Metric   @relation(fields: [metricId], references: [id], onDelete: Cascade)

  @@index([metricId, ts])
}

// --- Reports & Runs ---
model Report {
  id        String      @id @default(cuid())
  projectId String
  type      ReportType
  title     String
  contentMd String
  model     String?
  createdAt DateTime    @default(now())
  project   Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  runs      ReportRun[]
}

model ReportRun {
  id         String     @id @default(cuid())
  projectId  String
  reportId   String?
  type       ReportType
  status     RunStatus  @default(QUEUED)
  error      String?
  startedAt  DateTime?
  finishedAt DateTime?
  project    Project    @relation(fields: [projectId], references: [id], onDelete: Cascade)
  report     Report?    @relation(fields: [reportId], references: [id])
}
