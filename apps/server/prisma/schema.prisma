// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum ConfidenceLevel {
  LOW
  MEDIUM
  HIGH
}

enum AssumptionCategory {
  DESIRABILITY
  VIABILITY
  FEASIBILITY
  USABILITY
}

enum ValidationState {
  SUPPORTS
  WEAKENS
  FALSIFIES
  INCONCLUSIVE
}

enum LifecycleStage {
  DISCOVERED
  TRIANGULATED
  VALIDATED
  INSTITUTIONALIZED
  OBSOLETE
}

enum PrivacyLevel {
  PUBLIC
  INTERNAL
  RESTRICTED
}

enum ExperimentStatus {
  PLANNED
  RUNNING
  COMPLETE
  ARCHIVED
}

enum RelationshipType {
  OUTCOME_OPPORTUNITY
  OPPORTUNITY_SOLUTION
  SOLUTION_ASSUMPTION
  NODE
}

model Outcome {
  id             String   @id @default(uuid())
  name           String
  description    String?
  metricName     String?
  metricBaseline Float?
  metricTarget   Float?
  ownerId        String?
  status         String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  outcomeOpportunities OutcomeOpportunity[]
  Hypothesis           Hypothesis[]
  Insight              Insight[]

  @@index([ownerId])
}

model Opportunity {
  id          String   @id @default(uuid())
  description String
  segment     String?
  severity    String?
  status      String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  outcomeOpportunities OutcomeOpportunity[]
  opportunitySolutions OpportunitySolution[]
  Hypothesis           Hypothesis[]
  Insight              Insight[]
}

model Solution {
  id          String   @id @default(uuid())
  title       String
  description String?
  status      String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  opportunitySolutions OpportunitySolution[]
  solutionAssumptions  SolutionAssumption[]
  Hypothesis           Hypothesis[]
  Insight              Insight[]
}

model Assumption {
  id        String             @id @default(uuid())
  statement String
  category  AssumptionCategory
  riskLevel ConfidenceLevel?
  status    String?
  createdAt DateTime           @default(now())
  updatedAt DateTime           @updatedAt

  solutionAssumptions SolutionAssumption[]
  hypotheses          Hypothesis[]
  Insight             Insight[]
}

model OutcomeOpportunity {
  id            String  @id @default(uuid())
  outcomeId     String
  opportunityId String
  confidence    Float?
  notes         String?

  outcome     Outcome      @relation(fields: [outcomeId], references: [id], onDelete: Cascade)
  opportunity Opportunity  @relation(fields: [opportunityId], references: [id], onDelete: Cascade)
  insights    Insight[]
  Hypothesis  Hypothesis[]

  @@unique([outcomeId, opportunityId])
  @@index([opportunityId])
}

model OpportunitySolution {
  id            String  @id @default(uuid())
  opportunityId String
  solutionId    String
  confidence    Float?
  notes         String?

  opportunity Opportunity  @relation(fields: [opportunityId], references: [id], onDelete: Cascade)
  solution    Solution     @relation(fields: [solutionId], references: [id], onDelete: Cascade)
  insights    Insight[]
  Hypothesis  Hypothesis[]

  @@unique([opportunityId, solutionId])
  @@index([solutionId])
}

model SolutionAssumption {
  id           String  @id @default(uuid())
  solutionId   String
  assumptionId String
  confidence   Float?
  notes        String?

  solution   Solution     @relation(fields: [solutionId], references: [id], onDelete: Cascade)
  assumption Assumption   @relation(fields: [assumptionId], references: [id], onDelete: Cascade)
  insights   Insight[]
  Hypothesis Hypothesis[]

  @@unique([solutionId, assumptionId])
  @@index([assumptionId])
}

model Hypothesis {
  id                    String           @id @default(uuid())
  assumptionId          String?
  outcomeOpportunityId  String?
  opportunitySolutionId String?
  solutionAssumptionId  String?
  outcomeId             String?
  opportunityId         String?
  solutionId            String?
  statement             String
  targetType            RelationshipType
  createdById           String?
  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt

  assumption          Assumption?          @relation(fields: [assumptionId], references: [id], onDelete: SetNull)
  outcomeOpportunity  OutcomeOpportunity?  @relation(fields: [outcomeOpportunityId], references: [id], onDelete: SetNull)
  opportunitySolution OpportunitySolution? @relation(fields: [opportunitySolutionId], references: [id], onDelete: SetNull)
  solutionAssumption  SolutionAssumption?  @relation(fields: [solutionAssumptionId], references: [id], onDelete: SetNull)
  outcome             Outcome?             @relation(fields: [outcomeId], references: [id], onDelete: SetNull)
  opportunity         Opportunity?         @relation(fields: [opportunityId], references: [id], onDelete: SetNull)
  solution            Solution?            @relation(fields: [solutionId], references: [id], onDelete: SetNull)
  experiments         Experiment[]

  @@index([assumptionId])
  @@index([outcomeOpportunityId])
  @@index([opportunitySolutionId])
  @@index([solutionAssumptionId])
  @@index([outcomeId])
  @@index([opportunityId])
  @@index([solutionId])
}

model Experiment {
  id            String           @id @default(uuid())
  hypothesisId  String
  name          String
  method        String?
  status        ExperimentStatus @default(PLANNED)
  startAt       DateTime?
  endAt         DateTime?
  resultSummary String?
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt

  hypothesis Hypothesis @relation(fields: [hypothesisId], references: [id], onDelete: Cascade)
  insights   Insight[]

  @@index([hypothesisId])
}

model Insight {
  id                    String           @id @default(uuid())
  experimentId          String
  relationshipType      RelationshipType
  outcomeOpportunityId  String?
  opportunitySolutionId String?
  solutionAssumptionId  String?
  outcomeId             String?
  opportunityId         String?
  solutionId            String?
  assumptionId          String?
  validationState       ValidationState
  confidenceLevel       ConfidenceLevel  @default(MEDIUM)
  statement             String
  evidenceSummary       String
  sourceTypes           String[]
  tags                  String[]
  lifecycleStage        LifecycleStage   @default(DISCOVERED)
  privacyLevel          PrivacyLevel     @default(INTERNAL)
  discoveredOn          DateTime?
  validUntil            DateTime?
  dedupeHash            String?          @unique
  createdById           String?
  reviewedById          String?
  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt

  experiment          Experiment           @relation(fields: [experimentId], references: [id], onDelete: Cascade)
  outcomeOpportunity  OutcomeOpportunity?  @relation(fields: [outcomeOpportunityId], references: [id], onDelete: SetNull)
  opportunitySolution OpportunitySolution? @relation(fields: [opportunitySolutionId], references: [id], onDelete: SetNull)
  solutionAssumption  SolutionAssumption?  @relation(fields: [solutionAssumptionId], references: [id], onDelete: SetNull)
  outcome             Outcome?             @relation(fields: [outcomeId], references: [id], onDelete: SetNull)
  opportunity         Opportunity?         @relation(fields: [opportunityId], references: [id], onDelete: SetNull)
  solution            Solution?            @relation(fields: [solutionId], references: [id], onDelete: SetNull)
  assumption          Assumption?          @relation(fields: [assumptionId], references: [id], onDelete: SetNull)

  @@index([experimentId])
  @@index([outcomeOpportunityId])
  @@index([opportunitySolutionId])
  @@index([solutionAssumptionId])
  @@index([outcomeId])
  @@index([opportunityId])
  @@index([solutionId])
  @@index([assumptionId])
}
